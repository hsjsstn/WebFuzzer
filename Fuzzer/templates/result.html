<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Web Fuzzer - 결과</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='result.css') }}">
</head>
<body>
  {% include 'header.html' %}

  <h2 class="text-2xl font-bold text-center my-6">퍼징 결과</h2>

  <div class="flex justify-center mb-4 gap-4">
    <a href="{{ url_for('download_pdf') }}">
      <button class="btn-download">PDF 리포트 다운로드</button>
    </a>
    <a href="{{ url_for('download_logs') }}">
      <button class="btn-download">로그 TXT 파일 다운로드</button>
    </a>
  </div>

  <!-- 탭 버튼 -->
  <div class="flex justify-center space-x-4 mb-6">
    <button onclick="showTab('ai')" class="tab-button active" id="tab-ai">AI 요약</button>
    <button onclick="showTab('vulns')" class="tab-button" id="tab-vulns">유형별 취약점</button>
  </div>

  <!-- AI 요약 -->
  <div id="tab-ai-content" class="tab-content">
    <div id="ai-summary" class="rounded p-6 shadow mx-4 md:mx-24">
      <h3 class="text-xl font-semibold mb-3">AI 요약 및 대응책</h3>
      <p id="ai-summary-text" class="text-white whitespace-pre-line"></p>
    </div>
  </div>

  <!-- 유형별 취약점 -->
  <div id="tab-vulns-content" class="tab-content hidden">
    <div class="mx-4 md:mx-24 bg-#2c2c40 rounded p-6 shadow">
      <h3 class="text-xl font-semibold mb-3">발견된 취약점</h3>

      {% if vulnerabilities %}
    <table>
        <thead>
          <tr>
            <th>대상 URL</th>
            <th>취약점 유형</th>
            <th>페이로드</th>
          </tr>
        </thead>
        <tbody>
          {% for v in vulnerabilities %}
            <tr>
              <td>{{ v.form }}</td>
              <td>{{ v.type }}</td>
              <td>{{ v.payload }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-gray-500 text-center">발견된 취약점이 없습니다.</p>
      {% endif %}
    </div>
  </div>

  {% include 'footer.html' %}

  <script>
    // 탭 UI 토글
    function showTab(tab) {
      document.getElementById("tab-ai-content").classList.toggle("hidden", tab !== "ai");
      document.getElementById("tab-vulns-content").classList.toggle("hidden", tab !== "vulns");

      document.getElementById("tab-ai").classList.toggle("active", tab === "ai");
      document.getElementById("tab-vulns").classList.toggle("active", tab === "vulns");
    }

    // AI 요약 요청
    window.addEventListener("DOMContentLoaded", async () => {
      const vulnText = document.getElementById("vuln-results")?.innerText.trim();
      if (!vulnText || vulnText === "발견된 취약점이 없습니다.") {
        document.getElementById("ai-summary-text").innerText = "발견된 취약점이 없습니다.";
        return;
      }

      try {
        const response = await fetch("/ai-summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: vulnText })
        });

        const data = await response.json();
        document.getElementById("ai-summary-text").innerText = data.summary;
      } catch (error) {
        document.getElementById("ai-summary-text").innerText = "AI 요약 요청 중 오류가 발생했습니다.";
        console.error(error);
      }
    });
  </script>

  <!-- vuln text 숨기기용 -->
  <div id="vuln-results" style="display:none;">
    {% if vulnerabilities %}
      {% for v in vulnerabilities %}
- 유형: {{ v.type }}
- 페이로드: {{ v.payload }}

      {% endfor %}
    {% else %}
  발견된 취약점이 없습니다.
    {% endif %}
  </div>
</body>
</html>