<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Web Fuzzer - ê²°ê³¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='result.css') }}">
</head>
<body>
  {% include 'header.html' %}

  <h2 class="text-2xl font-bold text-center my-6">í¼ì§• ê²°ê³¼</h2>

  <div class="flex justify-center mb-4 gap-4">
    <a href="{{ url_for('download_pdf') }}">
      <button class="btn-download">PDF ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
    </a>
    <a href="{{ url_for('download_logs') }}">
      <button class="btn-download">ë¡œê·¸ TXT íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
    </a>
  </div>

  <!-- íƒ­ ë²„íŠ¼ -->
  <div class="flex justify-center space-x-4 mb-6">
    <button onclick="showTab('ai')" class="tab-button active" id="tab-ai">AI ìš”ì•½</button>
    <button onclick="showTab('dashboard')" class="tab-button" id="tab-dashboard">ëŒ€ì‹œë³´ë“œ</button>
    <button onclick="showTab('vulns')" class="tab-button" id="tab-vulns">ìœ í˜•ë³„ ì·¨ì•½ì </button>
  </div>

  <!-- AI ìš”ì•½ -->
  <div id="tab-ai-content" class="tab-content">
    <div id="ai-summary" class="rounded p-6 shadow">
      <h3 class="text-xl font-semibold mb-3">AI ìš”ì•½ ë° ëŒ€ì‘ì±…</h3>
      <p id="ai-summary-text" class="text-white whitespace-pre-line"></p>
    </div>
  </div>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div id="tab-dashboard-content" class="tab-content hidden">
    <div class="rounded-lg p-6 text-white" style="width: 700px; margin: 0 auto;">
      <h3 class="text-2xl font-semibold mb-6 text-center">ì·¨ì•½ì  í†µê³„ ëŒ€ì‹œë³´ë“œ</h3>
      <div class="flex flex-col md:flex-row gap-6 items-start">

        <!-- ì™¼ìª½ -->
        <div class="flex-1">
          <h4 class="text-lg font-bold mb-2">âš”ï¸ í˜ì´ì§€ë³„ ì·¨ì•½ì  ë¶„í¬</h4>
          <canvas id="pageChart" style="width: 100%; max-width: 700px; height: 600px;"></canvas>
        </div>

        <!-- ì˜¤ë¥¸ìª½ -->
        <div class="flex-1 space-y-6">
          <div class="p-4 bg-gray-700 rounded-lg shadow">
            <h4 class="text-lg font-bold mb-2">ğŸ“Œ ê°€ì¥ ë§ì´ ë°œê²¬ëœ ì·¨ì•½ì </h4>
            <p id="most-common-type" class="text-xl text-blue-300"></p>
          </div>
          <div class="p-4 bg-gray-700 rounded-lg shadow">
            <h4 class="text-lg font-bold mb-2">ğŸ“ˆ ì„±ê³µë¥  (ë°œê²¬ / ì‹œë„)</h4>
            <p id="success-rate" class="text-xl text-green-300"></p>
          </div>
          <div class="p-4 bg-gray-700 rounded-lg shadow">
            <h4 class="text-lg font-bold mb-2">ğŸ¯ ì·¨ì•½ì  ìœ í˜• ë¶„í¬</h4>
            <canvas id="vulnChart" style="width: 100%; max-width: 500px; height: 300px;"></canvas>
          </div>
        </div>

      </div>
    </div> 
  </div>

  <!-- ìœ í˜•ë³„ ì·¨ì•½ì  -->
  <div id="tab-vulns-content" class="tab-content hidden">
    <div class="mx-4 md:mx-24 bg-#2c2c40 rounded p-6 shadow">
      <h3 class="text-xl font-semibold mb-3">ë°œê²¬ëœ ì·¨ì•½ì </h3>

      {% if vulnerabilities %}
    <table>
        <thead>
          <tr>
            <th>ëŒ€ìƒ URL</th>
            <th>ì·¨ì•½ì  ìœ í˜•</th>
            <th>í˜ì´ë¡œë“œ</th>
          </tr>
        </thead>
        <tbody>
          {% for v in vulnerabilities %}
            <tr>
              <td>{{ v.form }}</td>
              <td>{{ v.type }}</td>
              <td>{{ v.payload }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-gray-500 text-center">ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endif %}
    </div>
  </div>

  {% include 'footer.html' %}

  <!-- vuln text ìˆ¨ê¸°ê¸°ìš© -->
  <div id="vuln-results" style="display:none;">
    {% if vulnerabilities %}
      {% for v in vulnerabilities %}
- ìœ í˜•: {{ v.type }}
- í˜ì´ë¡œë“œ: {{ v.payload }}
      {% endfor %}
    {% else %}
  ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.
    {% endif %}
  </div>

  <!-- ìœ í˜•ë³„ ì·¨ì•½ì  ìˆ˜ -->
  <script id="vuln-data-json" type="application/json">
    {{ vulnCounts | tojson | safe }}
  </script>

  <!-- ì·¨ì•½ì  ìƒì„¸ ëª©ë¡ -->
  <script id="vulnerabilities-json" type="application/json">
    {{ vulnerabilities | tojson | safe }}
  </script>

  <!-- ì „ì²´ ì‹œë„ ë‚´ì—­ -->
  <script id="attempts-json" type="application/json">
    {{ attempts | tojson | safe }}
  </script>

  <script>
     let pageChartInstance = null;
  let vulnChartInstance = null;

  function showTab(tab) {
    ["ai", "dashboard", "vulns"].forEach(id => {
      document.getElementById(`tab-${id}-content`).classList.toggle("hidden", id !== tab);
      document.getElementById(`tab-${id}`).classList.toggle("active", id === tab);
    });
  }

  window.addEventListener("DOMContentLoaded", async () => {
    const vulnText = document.getElementById("vuln-results")?.innerText.trim();
    if (!vulnText || vulnText === "ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.") {
      document.getElementById("ai-summary-text").innerText = "ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.";
    } else {
      try {
        const response = await fetch("/ai-summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: vulnText })
        });
        const data = await response.json();
        document.getElementById("ai-summary-text").innerText = data.summary;
      } catch (error) {
        document.getElementById("ai-summary-text").innerText = "AI ìš”ì•½ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        console.error(error);
      }
    }

    renderDashboard();
  });

  function renderDashboard() {
    const vulnData = JSON.parse(document.getElementById("vuln-data-json").textContent || "{}");
    const vulnerabilities = JSON.parse(document.getElementById("vulnerabilities-json").textContent || "[]");
    const attempts = JSON.parse(document.getElementById("attempts-json").textContent || "[]");

    // ğŸ”¹ ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (vulnChartInstance) vulnChartInstance.destroy();
    if (pageChartInstance) pageChartInstance.destroy();

    // ğŸ”¹ ìœ í˜•ë³„ ì·¨ì•½ì  ì°¨íŠ¸
    const ctx = document.getElementById('vulnChart').getContext('2d');
    vulnChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(vulnData),
        datasets: [{
          label: 'ì·¨ì•½ì  ìœ í˜•ë³„ ê°œìˆ˜',
          data: Object.values(vulnData),
          backgroundColor: [
            '#4f46e5', '#e11d48', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'
          ],
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });

    // ğŸ”¹ ê°€ì¥ ë§ì´ ë°œê²¬ëœ ìœ í˜•
    const total = Object.values(vulnData).reduce((a, b) => a + b, 0);
    if (total > 0) {
      const maxType = Object.entries(vulnData).reduce((a, b) => b[1] > a[1] ? b : a);
      document.getElementById("most-common-type").innerText =
        `${maxType[0]} (${((maxType[1] / total) * 100).toFixed(1)}%)`;
    } else {
      document.getElementById("most-common-type").innerText = "-";
    }

    // ğŸ”¹ ì„±ê³µë¥ 
    const successRate = attempts.length > 0
      ? ((vulnerabilities.length / attempts.length) * 100).toFixed(1)
      : "0.0";
    document.getElementById("success-rate").innerText =
      `${vulnerabilities.length} / ${attempts.length} (${successRate}%)`;

    // ğŸ”¹ í˜ì´ì§€ë³„ ë¶„í¬
    const pageCounts = {};
    vulnerabilities.forEach(v => {
      const page = v.form;
      pageCounts[page] = (pageCounts[page] || 0) + 1;
    });
    const ctx2 = document.getElementById('pageChart').getContext('2d');
    pageChartInstance = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: Object.keys(pageCounts),
        datasets: [{
          label: 'í˜ì´ì§€ë³„ ì·¨ì•½ì  ìˆ˜',
          data: Object.values(pageCounts),
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", renderDashboard);
  </script>
</body>
</html>
